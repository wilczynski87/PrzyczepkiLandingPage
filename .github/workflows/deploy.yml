name: Deploy Przyczepki Landing Page

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Pobranie kodu z repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Ustawienie SSH agent z kluczem
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.PRZYCZEPKI_WEB }}

      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@87.106.116.143 "
            set -e  # Zatrzymaj przy błędzie
          
            # Stwórz katalog jeśli nie istnieje
            mkdir -p /przyczepki-landing-page
            cd /przyczepki-landing-page
          
            # Klonowanie lub aktualizacja repo
            if [ ! -d .git ]; then
              echo \"Klonowanie repozytorium...\"
              git clone https://github.com/wilczynski87/PrzyczepkiLandingPage.git .
            else
              git fetch origin
              git reset --hard origin/master
            fi
          
            # Sprawdź czy docker-compose.yml istnieje
            if [ ! -f docker-compose.yml ]; then
              echo \"Brak docker-compose.yml!\"
              exit 1
            fi
          
            echo \"Budowanie i uruchamianie kontenerów...\"
            docker compose pull
            docker compose build --pull --no-cache
            docker compose up -d
          
            echo \"Sprawdzanie statusu kontenerów...\"
            sleep 5
            docker compose ps
          
            echo \"Deployment zakończony!\"
          "