package com.example.przyczepki_landingpage

import io.ktor.client.HttpClient
import io.ktor.client.call.body
import io.ktor.client.engine.js.Js
import io.ktor.client.plugins.ClientRequestException
import io.ktor.client.plugins.DefaultRequest
import io.ktor.client.plugins.HttpTimeout
import io.ktor.client.plugins.auth.Auth
import io.ktor.client.plugins.auth.providers.BearerTokens
import io.ktor.client.plugins.auth.providers.bearer
import io.ktor.client.plugins.cookies.AcceptAllCookiesStorage
import io.ktor.client.plugins.cookies.HttpCookies
import io.ktor.client.request.accept
import io.ktor.client.request.post
import io.ktor.client.request.setBody
import io.ktor.client.statement.bodyAsText
import io.ktor.http.ContentType
import io.ktor.http.contentType
import io.ktor.http.encodedPath
import io.ktor.serialization.kotlinx.json.json
import kotlinx.serialization.json.Json
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation

fun webCreateHttpClient(): HttpClient {

    return HttpClient(Js) {

        install(ContentNegotiation) {
            json(
                Json {
                    ignoreUnknownKeys = true
                    isLenient = true
                    classDiscriminator = "type"
//                    serializersModule = productSerializersModule
                }
            )
        }

        install(HttpTimeout) {
            requestTimeoutMillis = 15_000
            connectTimeoutMillis = 10_000
        }

        install(DefaultRequest) {
            contentType(ContentType.Application.Json)
            accept(ContentType.Application.Json)
        }

        install(HttpCookies) {
            storage = AcceptAllCookiesStorage()
        }

        expectSuccess = false

//        install(Auth) {
//            bearer {
//                loadTokens {
//                    val access = tokenManager.getAccessToken()
//                    val refresh = tokenManager.getRefreshToken()
//
//                    if (access != null) {
//                        BearerTokens(
//                            accessToken = access,
//                            refreshToken = refresh ?: ""
//                        )
//                    } else null
//                }
//
//                refreshTokens {
//                    val oldRefreshToken = tokenManager.getRefreshToken()
//                        ?: return@refreshTokens null
//
//                    try {
//                        val response: TokenResponse = client.post("$baseUrl/auth/refresh") {
//                            markAsRefreshTokenRequest()
//                            contentType(ContentType.Application.Json)
//                            setBody(RefreshTokenRequest(oldRefreshToken))
//                        }.body()
//
//                        println("✅ Token refresh successful")
//
//                        tokenManager.setTokens(
//                            response.accessToken,
//                            response.refreshToken
//                        )
//
//                        BearerTokens(
//                            accessToken = response.accessToken,
//                            refreshToken = response.refreshToken ?: ""
//                        )
//                    }  catch (e: ClientRequestException) {
//                        println("❌ Token refresh failed: ${e.response.status} - ${e.message}")
//                        // Spróbuj odczytać body błędu
//                        try {
//                            val errorBody = e.response.bodyAsText()
//                            println("Error body: $errorBody")
//                        } catch (ex: Exception) {
//                            // Ignoruj
//                        }
//                        tokenManager.clearTokens()
//                        null
//                    } catch (e: Exception) {
//                        println("❌ Token refresh failed: ${e.message}")
//                        e.printStackTrace()
//                        tokenManager.clearTokens()
//                        null
//                    }
//                }
//
//                sendWithoutRequest { request ->
//                    // Zawsze wysyłaj token (oprócz endpointów auth)
//                    !request.url.encodedPath.contains("/auth/login") &&
//                            !request.url.encodedPath.contains("/auth/register")
//                }
//            }
//        }
    }
}